<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心灵果园 - 治愈系切水果游戏</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comfortaa', cursive;
        }
        
        body {
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #00796b;
            overflow: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            animation: fadeIn 1.5s ease-out;
        }
        
        h1 {
            font-size: 3rem;
            color: #00796b;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.3rem;
            color: #004d40;
            margin-bottom: 20px;
            font-weight: 400;
        }
        
        .game-container {
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(0, 77, 64, 0.1);
            padding: 25px;
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            animation: slideUp 1s ease-out;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
            background-color: rgba(178, 223, 219, 0.3);
            padding: 15px;
            border-radius: 20px;
            font-size: 1.1rem;
            backdrop-filter: blur(5px);
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 1.5rem;
            color: #00796b;
        }
        
        #gameArea {
            width: 100%;
            height: 450px;
            background: linear-gradient(to bottom, #e0f2f1, #b2dfdb);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="%2300796b" opacity="0.6"/></svg>') 25 25, auto;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .fruit {
            position: absolute;
            font-size: 4rem;
            user-select: none;
            pointer-events: none;
            z-index: 10;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
            will-change: transform;
            animation: float 3s infinite alternate ease-in-out;
        }
        
        .sliced {
            opacity: 0;
            transform: scale(1.8) rotate(180deg);
            transition: all 0.5s ease-out;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(to right, #4db6ac, #00796b);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 105, 92, 0.3);
        }
        
        button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 105, 92, 0.4);
            background: linear-gradient(to right, #26a69a, #00695c);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .music-control {
            display: flex;
            align-items: center;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            border-radius: 50px;
        }
        
        #musicToggle {
            margin-left: 10px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        #musicToggle:hover {
            transform: scale(1.2);
        }
        
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 77, 64, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            display: none;
            animation: fadeIn 0.8s ease-out;
        }
        
        .result-content {
            background: linear-gradient(135deg, #4db6ac 0%, #00796b 100%);
            padding: 50px;
            border-radius: 30px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            animation: scaleIn 0.8s ease-out;
        }
        
        .result-content h2 {
            font-size: 3rem;
            margin-bottom: 30px;
            color: #e0f2f1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .result-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 30px 0;
            font-size: 1.3rem;
        }
        
        .result-stats div {
            display: flex;
            justify-content: space-between;
        }
        
        .highlight {
            color: #b2dfdb;
            font-weight: bold;
        }
        
        .splash {
            position: absolute;
            width: 150px;
            height: 150px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M30,50 Q50,30 70,50 Q50,70 30,50" fill="%234db6ac" opacity="0.7"/></svg>');
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 20;
            animation: fadeSplash 0.8s forwards;
        }
        
        .encouragement {
            position: absolute;
            font-size: 1.8rem;
            color: #00796b;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.8);
            z-index: 30;
            pointer-events: none;
            animation: floatUp 1.5s forwards;
            text-align: center;
        }
        
        .nature-bg {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            filter: blur(5px);
            animation: floatAcross 30s infinite linear;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-10px); }
        }
        
        @keyframes fadeSplash {
            0% { opacity: 1; transform: scale(0.5); }
            100% { opacity: 0; transform: scale(1.8); }
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
        
        @keyframes floatAcross {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(calc(100vw + 100px)); }
        }
        
        @media (max-width: 700px) {
            h1 {
                font-size: 2.5rem;
            }
            
            #gameArea {
                height: 350px;
            }
            
            .fruit {
                font-size: 3.5rem;
            }
            
            .stats-container {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .stat-item {
                flex: 1 0 45%;
            }
        }
        
        .back-to-chat {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            color: #00796b;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .back-to-chat:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <button class="back-to-chat" onclick="backToChat()">← 返回聊天</button>
    
    <header>
        <h1>心灵果园</h1>
        <div class="subtitle">放松心情，享受收获的喜悦。每一刻都值得珍惜</div>
    </header>
    
    <div class="game-container">
        <div class="stats-container">
            <div class="stat-item">
                <div>收获分数</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-item">
                <div>剩余时间</div>
                <div class="stat-value" id="timer">60</div>
            </div>
            <div class="stat-item">
                <div>收获次数</div>
                <div class="stat-value" id="hits">0</div>
            </div>
            <div class="stat-item">
                <div>喜悦指数</div>
                <div class="stat-value" id="accuracy">100%</div>
            </div>
        </div>
        
        <div id="gameArea">
            <!-- 水果和自然元素将动态生成 -->
        </div>
        
        <div class="controls">
            <button id="startBtn">开始放松</button>
            <button id="pauseBtn" disabled>稍作休息</button>
        </div>
        
        <div class="music-control">
            <span>自然音律：</span>
            <span id="musicToggle">🔊</span>
        </div>
    </div>
    
    <div class="game-over" id="gameOver">
        <div class="result-content">
            <h2>收获时间结束</h2>
            <div class="result-stats">
                <div><span>收获总分：</span><span class="highlight" id="finalScore">0</span></div>
                <div><span>收获次数：</span><span class="highlight" id="finalHits">0</span></div>
                <div><span>喜悦指数：</span><span class="highlight" id="finalAccuracy">100%</span></div>
                <div><span>收获速度：</span><span class="highlight" id="fruitPerMin">0/分钟</span></div>
                <div><span>放松程度：</span><span class="highlight" id="relaxLevel">非常放松</span></div>
            </div>
            <button id="playAgain">再次放松</button>
        </div>
    </div>
    
    <script>
        function backToChat() {
            // 关闭当前标签页，如果是最后一个标签页则返回聊天界面
            if (window.opener) {
                window.close();
            } else {
                window.location.href = '/chat';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // 游戏配置 - 针对抑郁症患者的优化设置
            const config = {
                gameTime: 60,
                minSpawnInterval: 1000,
                maxSpawnInterval: 1800,
                fruitSpeed: 3.0,
                fruits: ['🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥'],
                encouragements: [
                    "做得好！", "太棒了！", "继续努力！", "你真了不起！", 
                    "保持节奏！", "令人惊叹！", "放松心情~", "享受此刻",
                    "呼吸放松", "专注当下", "你值得快乐", "慢慢来"
                ]
            };
            
            // 游戏状态
            let gameState = {
                score: 0,
                timeLeft: config.gameTime,
                hits: 0,
                misses: 0,
                gameActive: false,
                musicOn: true,
                fruitCount: 0,
                encouragements: [],
                lastEncouragementTime: 0
            };
            
            // DOM元素
            const gameArea = document.getElementById('gameArea');
            const scoreEl = document.getElementById('score');
            const timerEl = document.getElementById('timer');
            const hitsEl = document.getElementById('hits');
            const accuracyEl = document.getElementById('accuracy');
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const musicToggle = document.getElementById('musicToggle');
            const gameOver = document.getElementById('gameOver');
            const finalScoreEl = document.getElementById('finalScore');
            const finalHitsEl = document.getElementById('finalHits');
            const finalAccuracyEl = document.getElementById('finalAccuracy');
            const fruitPerMinEl = document.getElementById('fruitPerMin');
            const relaxLevelEl = document.getElementById('relaxLevel');
            const playAgainBtn = document.getElementById('playAgain');
            
            // 游戏变量
            let gameInterval;
            let spawnInterval;
            let lastPoint = { x: 0, y: 0 };
            
            // 初始化自然背景
            initNatureBackground();
            
            // 事件监听
            startBtn.addEventListener('click', startGame);
            pauseBtn.addEventListener('click', pauseGame);
            musicToggle.addEventListener('click', toggleMusic);
            playAgainBtn.addEventListener('click', startGame);
            gameArea.addEventListener('mousedown', startSwipe);
            gameArea.addEventListener('touchstart', startSwipeTouch);
            gameArea.addEventListener('mousemove', trackSwipes);
            gameArea.addEventListener('touchmove', trackSwipesTouch);
            
            // 初始化自然背景
            function initNatureBackground() {
                for (let i = 0; i < 5; i++) {
                    const cloud = document.createElement('div');
                    cloud.className = 'cloud';
                    cloud.style.width = `${60 + Math.random() * 100}px`;
                    cloud.style.height = `${40 + Math.random() * 60}px`;
                    cloud.style.top = `${Math.random() * 30}%`;
                    cloud.style.left = `${Math.random() * 100}%`;
                    cloud.style.animationDuration = `${40 + Math.random() * 50}s`;
                    cloud.style.opacity = `${0.4 + Math.random() * 0.4}`;
                    gameArea.appendChild(cloud);
                }
            }
            
            // 游戏逻辑函数（保持原有功能）
            function startGame() {
                resetGame();
                gameOver.style.display = 'none';
                gameState.gameActive = true;
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                gameInterval = setInterval(updateGame, 1000);
                spawnFruit();
                spawnInterval = setInterval(spawnFruit, getRandomInt(config.minSpawnInterval, config.maxSpawnInterval));
            }
            
            function pauseGame() {
                if (gameState.gameActive) {
                    gameState.gameActive = false;
                    clearInterval(gameInterval);
                    clearInterval(spawnInterval);
                    pauseBtn.textContent = "继续放松";
                    showEncouragement("休息一下也很好", true);
                } else {
                    gameState.gameActive = true;
                    gameInterval = setInterval(updateGame, 1000);
                    spawnInterval = setInterval(spawnFruit, getRandomInt(config.minSpawnInterval, config.maxSpawnInterval));
                    pauseBtn.textContent = "稍作休息";
                    showEncouragement("欢迎回来", true);
                }
            }
            
            function resetGame() {
                gameState.score = 0;
                gameState.timeLeft = config.gameTime;
                gameState.hits = 0;
                gameState.misses = 0;
                gameState.fruitCount = 0;
                gameState.lastEncouragementTime = 0;
                
                scoreEl.textContent = "0";
                timerEl.textContent = "60";
                hitsEl.textContent = "0";
                accuracyEl.textContent = "100%";
                
                document.querySelectorAll('.fruit').forEach(fruit => fruit.remove());
            }
            
            function updateGame() {
                gameState.timeLeft--;
                timerEl.textContent = gameState.timeLeft;
                
                const timePassed = config.gameTime - gameState.timeLeft;
                if (timePassed % 10 === 0 && timePassed > 0) {
                    clearInterval(spawnInterval);
                    const newInterval = Math.max(600, config.minSpawnInterval - timePassed * 20);
                    spawnInterval = setInterval(spawnFruit, getRandomInt(newInterval, config.maxSpawnInterval));
                    showEncouragement("做得很好，继续享受", false);
                }
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }
            
            function spawnFruit() {
                if (!gameState.gameActive) return;
                
                const fruit = document.createElement('div');
                fruit.className = 'fruit';
                fruit.textContent = config.fruits[Math.floor(Math.random() * config.fruits.length)];
                
                const xPos = Math.random() * (gameArea.offsetWidth - 80);
                fruit.style.left = `${xPos}px`;
                fruit.style.bottom = '-80px';
                
                gameArea.appendChild(fruit);
                
                const startTime = Date.now();
                const animation = setInterval(() => {
                    if (!gameState.gameActive) {
                        clearInterval(animation);
                        return;
                    }
                    
                    const elapsed = (Date.now() - startTime) / 1000;
                    const progress = elapsed / config.fruitSpeed;
                    
                    if (progress >= 1) {
                        clearInterval(animation);
                        if (fruit.parentNode) {
                            fruit.remove();
                        }
                    } else {
                        fruit.style.bottom = `${-80 + progress * (gameArea.offsetHeight + 160)}px`;
                    }
                }, 16);
                
                gameState.fruitCount++;
            }
            
            function startSwipe(e) {
                if (!gameState.gameActive) return;
                lastPoint = { x: e.clientX, y: e.clientY };
                gameArea.addEventListener('mouseup', endSwipe);
            }
            
            function startSwipeTouch(e) {
                if (!gameState.gameActive) return;
                lastPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                gameArea.addEventListener('touchend', endSwipeTouch);
            }
            
            function trackSwipes(e) {
                if (!gameState.gameActive) return;
                const currentPoint = { x: e.clientX, y: e.clientY };
                checkFruitSlice(currentPoint);
                lastPoint = currentPoint;
            }
            
            function trackSwipesTouch(e) {
                if (!gameState.gameActive) return;
                e.preventDefault();
                const currentPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                checkFruitSlice(currentPoint);
                lastPoint = currentPoint;
            }
            
            function endSwipe() {
                gameArea.removeEventListener('mouseup', endSwipe);
            }
            
            function endSwipeTouch() {
                gameArea.removeEventListener('touchend', endSwipeTouch);
            }
            
            function checkFruitSlice(point) {
                const fruits = document.querySelectorAll('.fruit:not(.sliced)');
                const rect = gameArea.getBoundingClientRect();
                const x = point.x - rect.left;
                const y = point.y - rect.top;
                
                fruits.forEach(fruit => {
                    const fruitRect = fruit.getBoundingClientRect();
                    const fruitX = fruitRect.left + fruitRect.width/2 - rect.left;
                    const fruitY = fruitRect.top + fruitRect.height/2 - rect.top;
                    
                    const dx = x - fruitX;
                    const dy = y - fruitY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 60) {
                        sliceFruit(fruit);
                    }
                });
            }
            
            function sliceFruit(fruit) {
                if (fruit.classList.contains('sliced')) return;
                
                fruit.classList.add('sliced');
                
                const splash = document.createElement('div');
                splash.className = 'splash';
                splash.style.left = `${fruit.offsetLeft - 50}px`;
                splash.style.top = `${fruit.offsetTop - 50}px`;
                gameArea.appendChild(splash);
                
                setTimeout(() => {
                    splash.remove();
                }, 800);
                
                gameState.score += 10;
                gameState.hits++;
                scoreEl.textContent = gameState.score;
                hitsEl.textContent = gameState.hits;
                updateAccuracy();
                
                const now = Date.now();
                if (now - gameState.lastEncouragementTime > 3000) {
                    const encouragement = config.encouragements[Math.floor(Math.random() * config.encouragements.length)];
                    showEncouragement(encouragement, false);
                    gameState.lastEncouragementTime = now;
                }
                
                setTimeout(() => {
                    if (fruit.parentNode) {
                        fruit.remove();
                    }
                }, 500);
            }
            
            function showEncouragement(text, isImportant) {
                if (!isImportant && !gameState.gameActive) return;
                
                const encouragement = document.createElement('div');
                encouragement.className = 'encouragement';
                encouragement.textContent = text;
                encouragement.style.left = `${gameArea.offsetWidth / 2 - 100}px`;
                encouragement.style.top = `${gameArea.offsetHeight / 2}px`;
                gameArea.appendChild(encouragement);
                
                setTimeout(() => {
                    if (encouragement.parentNode) {
                        encouragement.remove();
                    }
                }, 1500);
            }
            
            function updateAccuracy() {
                const total = gameState.hits + gameState.misses;
                const accuracy = total > 0 ? Math.round((gameState.hits / total) * 100) : 100;
                accuracyEl.textContent = `${accuracy}%`;
            }
            
            function toggleMusic() {
                musicToggle.textContent = gameState.musicOn ? '🔇' : '🔊';
                gameState.musicOn = !gameState.musicOn;
            }
            
            function endGame() {
                clearInterval(gameInterval);
                clearInterval(spawnInterval);
                gameState.gameActive = false;
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                pauseBtn.textContent = "稍作休息";
                
                const totalFruits = gameState.hits + gameState.misses;
                const accuracy = totalFruits > 0 ? Math.round((gameState.hits / totalFruits) * 100) : 100;
                
                const playTime = config.gameTime - gameState.timeLeft;
                const fruitsPerMin = playTime > 0 ? Math.round((gameState.hits / playTime) * 60) : gameState.hits;
                
                let relaxLevel;
                if (accuracy >= 90) relaxLevel = "非常放松";
                else if (accuracy >= 70) relaxLevel = "比较放松";
                else if (accuracy >= 50) relaxLevel = "稍有压力";
                else relaxLevel = "需要更多练习";
                
                finalScoreEl.textContent = gameState.score;
                finalHitsEl.textContent = gameState.hits;
                finalAccuracyEl.textContent = `${accuracy}%`;
                fruitPerMinEl.textContent = `${fruitsPerMin}/分钟`;
                relaxLevelEl.textContent = relaxLevel;
                
                gameOver.style.display = 'flex';
            }
            
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
        });
    </script>
</body>
</html>